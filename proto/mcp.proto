// /pandacea/mcp.proto
// Defines the Pandacea Model Context Protocol (MCP) messages.
// Version: 1.1.0

syntax = "proto3";

package pandacea.mcp;

// Import standard Google well-known types.
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/any.proto"; // For extensions

// --- Core Message Definitions ---

// Represents a request initiated by a Requestor (e.g., app, agent).
message McpRequest {
  // Unique identifier for this specific request message (e.g., UUID v4 string).
  // REQUIRED. Must not be empty.
  string request_id = 1;

  // Timestamp indicating when the request was created by the requestor.
  // REQUIRED. Must be a valid timestamp.
  google.protobuf.Timestamp timestamp = 2;

  // Information about the entity making the request.
  // REQUIRED.
  RequestorIdentity requestor_identity = 3;

  // Detailed description of the purpose for which data/action is requested.
  // REQUIRED.
  PurposeDNA purpose_dna = 4;

  // List of specific permissions (data access or actions) sought by this request.
  // REQUIRED. Must contain at least one permission.
  repeated PermissionSpecification permissions = 5;

  // Optional: Timestamp after which this specific request message is considered invalid
  // by the responder. If set, must be after the `timestamp`.
  google.protobuf.Timestamp request_expiry = 6;

  // Cryptographic signature covering the request fields (typically 1-6, 8, 9, 11).
  // The exact fields covered and canonicalization method should be specified
  // by the implementation or a companion spec.
  // REQUIRED for security validation.
  CryptoSignature signature = 7;

  // Version string of the MCP schema this request adheres to (e.g., "1.1.0").
  // REQUIRED. Must follow semantic versioning principles.
  string mcp_version = 8;

  // Optional: Identifier of a previous request this one relates to
  // (e.g., for updating a previous grant, renewing consent).
  string related_request_id = 9;

  // Optional: Field for future protocol extensions or custom data.
  // Implementations should ignore extensions they don't understand.
  repeated google.protobuf.Any extensions = 10;

  // Optional: Additional contextual data relevant to the request,
  // provided by the requestor. Can be used by the Consent Manager for evaluation.
  // Example: {"app_version": "1.2.3", "foreground": true}
  google.protobuf.Struct context_data = 11;
  
  // NEW: Optional: Compensation model for data access.
  // Describes how data providers will be compensated for this request.
  CompensationModel compensation_model = 12;
  
  // NEW: Optional: Trust information about the requesting entity.
  // Provides additional context about the requestor's reputation and trustworthiness.
  TrustInformation trust_info = 13;
  
  // NEW: Optional: Authentication information.
  // How the requestor has been authenticated.
  AuthenticationInfo authentication_info = 14;
}

// Represents a response generated by a Responder (e.g., Consent Manager).
message McpResponse {
  // Unique identifier for this specific response message (e.g., UUID v4 string).
  // REQUIRED. Must not be empty.
  string response_id = 1;

  // The unique ID of the `McpRequest` this response corresponds to.
  // REQUIRED. Must match the `request_id` of the initiating request.
  string request_id = 2;

  // Timestamp indicating when the response was generated by the responder.
  // REQUIRED. Must be a valid timestamp.
  google.protobuf.Timestamp timestamp = 3;

  // Overall status of the request processing.
  // REQUIRED. Must not be STATUS_UNSPECIFIED.
  Status status = 4;

  // Optional: Human-readable message providing context for the status,
  // especially useful for DENIED, ERROR, or PARTIALLY_APPROVED statuses.
  string status_message = 5;

  // Optional: Provides granular status for each permission requested.
  // REQUIRED if `status` is PARTIALLY_APPROVED.
  // MUST contain entries corresponding to all permissions in the original request
  // if the status is PARTIALLY_APPROVED.
  repeated PermissionStatus permission_statuses = 6;

  // Optional: Payload containing data returned as a result of an approved READ request.
  // The format depends on the requested resource. Could be raw bytes,
  // or potentially a google.protobuf.Any for structured data.
  bytes response_payload = 7;

  // Optional: A cryptographic receipt or proof of the consent decision.
  // The format and content are implementation-specific but should allow
  // verification of the consent grant/denial. Could be a signed hash
  // of key decision elements (request hash, purpose hash, rules evaluated, timestamp).
  bytes consent_receipt = 8;

  // Cryptographic signature covering the response fields (typically 1-8, 10).
  // The exact fields covered and canonicalization method should be specified
  // by the implementation or a companion spec.
  // REQUIRED for verifying the responder's authenticity and integrity.
  CryptoSignature signature = 9;

  // Version string of the MCP schema this response adheres to (e.g., "1.1.0").
  // REQUIRED. Must follow semantic versioning principles.
  string mcp_version = 10;

  // Optional: Field for future protocol extensions or custom data.
  repeated google.protobuf.Any extensions = 11;

  // NEW: Optional: Compensation receipt.
  // Verifiable proof of the compensation transaction for this data access.
  CompensationReceipt compensation_receipt = 12;
  
  // NEW: Optional: Consent expiry.
  // When the granted consent expires (separate from the request expiry).
  google.protobuf.Timestamp consent_expiry = 13;
  
  // NEW: Optional: Usage limitations.
  // Specific limitations on how the data can be used beyond the basic permissions.
  UsageLimitations usage_limitations = 14;

  // Nested enum for the overall status.
  enum Status {
    STATUS_UNSPECIFIED = 0; // Default, should not be used in a valid response.
    APPROVED = 1;           // The request (all permissions) was approved.
    PARTIALLY_APPROVED = 2; // Some permissions approved, some denied (see permission_statuses).
    DENIED = 3;             // The request (all permissions) was denied.
    ERROR = 4;              // An error occurred processing the request (details in status_message).
    PENDING = 5;            // The request requires further action (e.g., user interaction).
  }

  // Nested message for per-permission status.
  message PermissionStatus {
    // Matches PermissionSpecification.resource_identifier from the request.
    // REQUIRED.
    string resource_identifier = 1;

    // Matches PermissionSpecification.requested_action from the request.
    // REQUIRED. Must not be ACTION_UNSPECIFIED.
    PermissionSpecification.Action requested_action = 2;

    // Indicates if this specific permission was granted.
    // REQUIRED.
    bool granted = 3;

    // Optional: Reason if the permission was denied (`granted` is false).
    string reason = 4;
    
    // NEW: Optional: Specific conditions applied to this permission.
    // Additional conditions beyond the basic grant/deny decision.
    google.protobuf.Struct conditions = 5;
    
    // NEW: Optional: Duration for which this permission is granted.
    // Can be different for different permissions in the same request.
    uint64 duration_seconds = 6;
  }
}


// --- Supporting Structures ---

// Defines cryptographic signature information.
message CryptoSignature {
  // Identifier for the public key used for verification (e.g., key fingerprint, URI, alias).
  // REQUIRED. Must not be empty.
  string key_id = 1;

  // Algorithm used for signing (e.g., "Ed25519", "ECDSA-P256").
  // REQUIRED. Must be a recognized algorithm identifier.
  string algorithm = 2;

  // The actual signature bytes.
  // REQUIRED. Must not be empty.
  bytes signature = 3;
  
  // NEW: Optional: Additional metadata about the signature.
  // Could include information about certificate chains, etc.
  google.protobuf.Struct signature_metadata = 4;
}

// Represents the identity of the entity making a request.
message RequestorIdentity {
  // A stable pseudonymous identifier for the requestor (e.g., DID, unique username).
  // REQUIRED. Must not be empty.
  string pseudonym_id = 1;

  // The public key associated with the pseudonym_id, used for signature verification.
  // The format depends on the algorithm specified in the signature.
  // REQUIRED. Must not be empty.
  bytes public_key = 2;

  // Optional: List of URLs pointing to verifiable claims or attestations about the requestor
  // (e.g., certifications, membership proofs). Verification mechanism is out of scope for MCP core.
  repeated string attestations = 3;

  // Optional: Trust tier assigned to the requestor by the *responder's* system.
  // This is informational for the responder and may influence policy decisions.
  // It's not typically set *by* the requestor themselves.
  uint32 trust_tier = 4;
  
  // NEW: Optional: Organization identifier.
  // If the requestor is part of a larger organization, this identifies it.
  string organization_id = 5;
  
  // NEW: Optional: Human-readable name of the requestor or organization.
  // User-friendly display name for consent UIs.
  string display_name = 6;
  
  // NEW: Optional: Public profile URL of the requestor.
  // Where users can learn more about the requestor.
  string profile_url = 7;
  
  // NEW: Optional: Type of the requestor entity.
  // Helps classify different types of requestors.
  RequestorType requestor_type = 8;
  
  // Enum for the requestor type
  enum RequestorType {
    REQUESTOR_TYPE_UNSPECIFIED = 0; // Default, should not be used in valid messages
    INDIVIDUAL = 1;                 // Individual human
    ORGANIZATION = 2;               // Formal organization or company
    AI_AGENT = 3;                   // Autonomous AI agent
    SERVICE = 4;                    // Technical service or API
    DEVICE = 5;                     // IoT or physical device
  }
}

// Describes the purpose for which data or action is requested.
// Aligned with concepts like GDPR's "purpose limitation".
message PurposeDNA {
  // A unique identifier for this specific purpose instance or definition.
  // Could be a URI pointing to a registry or a locally unique ID.
  // REQUIRED. Must not be empty.
  string purpose_id = 1;

  // High-level category of the purpose. Use standardized values where possible.
  // REQUIRED. Must not be PURPOSE_CATEGORY_UNSPECIFIED.
  PurposeCategory primary_purpose_category = 2;

  // Optional: Additional purpose categories if the request serves multiple goals.
  repeated PurposeCategory secondary_purpose_categories = 12;

  // Detailed, human-readable description of the specific purpose.
  // Should be clear and unambiguous for user comprehension.
  // REQUIRED. Must not be empty.
  string specific_purpose_description = 3;

  // List of data types or resource categories involved (e.g., "user.email", "device.location.coarse").
  // REQUIRED. Must contain entries corresponding to requested permission resources.
  repeated string data_types_involved = 4;

  // Description of how the data will be processed or the action performed.
  // REQUIRED. Must not be empty.
  string processing_description = 5;

  // Description of data storage location, duration, and security measures.
  // REQUIRED. Must not be empty.
  string storage_description = 6;

  // Optional: Identifiers or categories of any third parties who might receive the data.
  repeated string intended_recipients = 7;

  // Optional: Timestamp after which consent granted for this specific purpose definition expires.
  // This relates to the validity of the purpose itself, distinct from `request_expiry`.
  google.protobuf.Timestamp purpose_expiry_timestamp = 8;

  // Optional: Link to a more detailed privacy policy or legal justification.
  string legal_context_url = 9;

  // Optional: Legal basis claimed for processing (e.g., "Consent", "LegitimateInterest", "Contract").
  string legal_basis = 13;

  // Optional: Jurisdiction(s) whose laws are considered applicable.
  string jurisdiction = 14;

  // Optional: Details about third-party sharing, if any.
  ThirdPartySharing third_party_sharing = 15;

  // Optional: Metadata specific to AI agents involved in the request/processing.
  // Example: {"agent_model": "model-v3", "task_type": "summarization"}
  google.protobuf.Struct agent_metadata = 10;

  // Optional: Additional constraints related to the purpose itself.
  // Example: {"data_minimization_level": "high"}
  google.protobuf.Struct constraints = 11;
  
  // NEW: Optional: Impact assessment.
  // Description of potential impact of this data use on individuals.
  string impact_assessment = 16;
  
  // NEW: Optional: Reuse limitations.
  // Whether and how the data can be reused for other purposes.
  ReuseLimitations reuse_limitations = 17;

  // Enum for high-level purpose categories. Extend as needed.
  enum PurposeCategory {
    PURPOSE_CATEGORY_UNSPECIFIED = 0; // Default, invalid if used as primary.
    ANALYTICS = 1;                    // Understanding usage patterns, product improvement.
    PERSONALIZATION = 2;              // Tailoring content or experience to the user.
    RESEARCH_DEVELOPMENT = 3;         // R&D, model training, scientific study.
    SECURITY = 4;                     // Fraud detection, authentication, system integrity.
    OPERATIONS = 5;                   // Core service functionality, debugging, maintenance.
    MARKETING_ADVERTISING = 6;        // Promoting products or services.
    LEGAL_COMPLIANCE = 7;             // Fulfilling legal or regulatory obligations.
    COMMUNICATIONS = 8;               // Sending messages to the user (notifications, etc.).
    // Add other common categories as needed...
  }

  // Details about third-party sharing.
  message ThirdPartySharing {
    // Is data shared with third parties?
    bool is_shared = 1;
    // List of third-party identifiers or categories. Required if is_shared is true.
    repeated string recipients = 2;
    // Purpose for which data is shared with third parties. Required if is_shared is true.
    string sharing_purpose_description = 3;
    
    // NEW: Optional: Data elements to be shared.
    // Specific data elements that would be shared with third parties.
    repeated string shared_data_elements = 4;
    
    // NEW: Optional: Controls available to users.
    // Description of controls users have over third-party sharing.
    string user_controls = 5;
  }
  
  // NEW: Limitations on how data can be reused
  message ReuseLimitations {
    // Is reuse allowed?
    bool is_reuse_allowed = 1;
    
    // What types of reuse are permitted
    repeated ReuseType permitted_reuse_types = 2;
    
    // Optional: Specific conditions for reuse
    string reuse_conditions = 3;
    
    // Types of data reuse
    enum ReuseType {
      REUSE_TYPE_UNSPECIFIED = 0;   // Default, invalid if used
      INTERNAL_ANALYTICS = 1;       // Internal analytics within organization
      MODEL_TRAINING = 2;           // Training AI/ML models
      RESEARCH = 3;                 // Research purposes
      PRODUCT_IMPROVEMENT = 4;      // Improving existing products
      NEW_PRODUCT_DEVELOPMENT = 5;  // Developing new products
      AGGREGATED_INSIGHTS = 6;      // Creating aggregated insights
    }
  }
}

// Specifies a single permission being requested (a data access or an action).
message PermissionSpecification {
  // Identifier for the specific resource being targeted (e.g., data field path "user.profile.email",
  // API endpoint "/api/v1/status", sensor name "env_sensor_temp").
  // REQUIRED. Must not be empty.
  string resource_identifier = 1;

  // The type of action requested on the resource.
  // REQUIRED. Must not be ACTION_UNSPECIFIED.
  Action requested_action = 2;

  // Optional: Fine-grained constraints on the permission.
  // Uses Struct for flexibility. Examples:
  // {"max_frequency_per_hour": 10}
  // {"location_precision": "city"}
  // {"data_access_scope": "aggregated"} // e.g., "personal", "aggregated", "anonymized"
  // {"valid_start_time": "2024-01-01T00:00:00Z", "valid_end_time": "2024-12-31T23:59:59Z"}
  google.protobuf.Struct constraints = 3;

  // Optional: Chain of delegation identifiers if this permission was delegated.
  // Format TBD, could be requestor IDs or specific delegation tokens.
  repeated string delegation_chain = 4;
  
  // NEW: Optional: Sensitivity level of this resource.
  // Indicates how sensitive or critical this resource is.
  SensitivityLevel sensitivity_level = 5;
  
  // NEW: Optional: Permission justification.
  // Explanation for why this specific permission is needed.
  string justification = 6;

  // Enum for the type of action requested.
  enum Action {
    ACTION_UNSPECIFIED = 0; // Default, invalid if used.
    READ = 1;               // Requesting to read/retrieve data.
    WRITE = 2;              // Requesting to write/modify/create data.
    DELETE = 5;             // Requesting to delete data. (Added based on common CRUD)
    EXECUTE = 3;            // Requesting to perform an action/function/call an API.
    OBSERVE = 4;            // Requesting to subscribe to data streams/events.
  }
  
  // NEW: Enum for sensitivity level
  enum SensitivityLevel {
    SENSITIVITY_UNSPECIFIED = 0;  // Default, invalid if used
    LOW = 1;                      // Low sensitivity, minimal privacy impact
    MEDIUM = 2;                   // Medium sensitivity, moderate privacy impact
    HIGH = 3;                     // High sensitivity, significant privacy impact
    CRITICAL = 4;                 // Critical sensitivity, severe privacy impact
  }
}

// NEW: Compensation model for data access
message CompensationModel {
  // Type of compensation being offered
  CompensationType compensation_type = 1;
  
  // Amount of compensation (interpretation depends on type)
  double amount = 2;
  
  // Currency or token unit (e.g., "USD", "DATA", "CREDITS")
  string unit = 3;
  
  // Payment method details (could be crypto wallet, payment processor, etc.)
  PaymentMethod payment_method = 4;
  
  // Optional: Revenue sharing model if applicable
  RevenueSharing revenue_sharing = 5;
  
  // Types of compensation
  enum CompensationType {
    COMPENSATION_TYPE_UNSPECIFIED = 0;  // Default, invalid if used
    MONETARY = 1;                       // Direct monetary payment
    TOKEN = 2;                          // Digital token or credit
    SERVICE_ACCESS = 3;                 // Access to services or features
    REVENUE_SHARE = 4;                  // Share of revenue from data use
    NON_MONETARY = 5;                   // Non-monetary benefits
    NONE = 6;                           // No compensation offered
  }
  
  // Payment method details
  message PaymentMethod {
    // Type of payment method
    string payment_type = 1;
    
    // Identifier for the payment method (wallet address, account ID, etc.)
    string payment_identifier = 2;
    
    // Optional: Additional payment details
    google.protobuf.Struct payment_details = 3;
  }
  
  // Revenue sharing model
  message RevenueSharing {
    // Percentage of revenue to be shared (0-100)
    double percentage = 1;
    
    // Description of how revenue is calculated
    string calculation_method = 2;
    
    // Optional: Payment frequency (e.g., "monthly", "quarterly")
    string payment_frequency = 3;
    
    // Optional: Minimum payment threshold
    double minimum_threshold = 4;
  }
}

// NEW: Receipt for compensation payment
message CompensationReceipt {
  // Transaction ID for the compensation payment
  string transaction_id = 1;
  
  // Timestamp when the compensation was processed
  google.protobuf.Timestamp timestamp = 2;
  
  // Amount that was paid
  double amount = 3;
  
  // Currency or token unit
  string unit = 4;
  
  // Status of the payment
  PaymentStatus status = 5;
  
  // Optional: Verification data for the transaction
  bytes verification_data = 6;
  
  // Optional: Additional payment metadata
  google.protobuf.Struct payment_metadata = 7;
  
  // Payment status
  enum PaymentStatus {
    PAYMENT_STATUS_UNSPECIFIED = 0;  // Default, invalid if used
    PENDING = 1;                     // Payment initiated but not confirmed
    COMPLETED = 2;                   // Payment completed successfully
    FAILED = 3;                      // Payment failed
    ESCROW = 4;                      // Payment held in escrow
  }
}

// NEW: Trust information about the requestor
message TrustInformation {
  // Trust score (0-100, higher is more trusted)
  uint32 trust_score = 1;
  
  // Trust assessment methodology
  string assessment_method = 2;
  
  // Entity that performed the trust assessment
  string assessment_provider = 3;
  
  // Optional: Timestamp when trust was assessed
  google.protobuf.Timestamp assessment_timestamp = 4;
  
  // Optional: List of trust credentials or certificates
  repeated TrustCredential trust_credentials = 5;
  
  // Trust credential details
  message TrustCredential {
    // Type of credential
    string credential_type = 1;
    
    // Issuer of the credential
    string issuer = 2;
    
    // Credential identifier
    string credential_id = 3;
    
    // Optional: When the credential expires
    google.protobuf.Timestamp expiry = 4;
    
    // Optional: Verification URL for the credential
    string verification_url = 5;
  }
}

// NEW: Authentication information
message AuthenticationInfo {
  // Method used for authentication
  AuthMethod auth_method = 1;
  
  // Identifier for the authentication provider
  string auth_provider = 2;
  
  // Authentication level achieved
  AuthLevel auth_level = 3;
  
  // Optional: When authentication was performed
  google.protobuf.Timestamp auth_timestamp = 4;
  
  // Optional: Additional authentication details
  google.protobuf.Struct auth_details = 5;
  
  // Authentication methods
  enum AuthMethod {
    AUTH_METHOD_UNSPECIFIED = 0;  // Default, invalid if used
    PASSWORD = 1;                 // Username/password
    OAUTH = 2;                    // OAuth flow
    PKI = 3;                      // Public key infrastructure
    BIOMETRIC = 4;                // Biometric authentication
    MFA = 5;                      // Multi-factor authentication
    SSO = 6;                      // Single sign-on
    DECENTRALIZED = 7;            // Decentralized identity (e.g., DIDs)
  }
  
  // Authentication levels
  enum AuthLevel {
    AUTH_LEVEL_UNSPECIFIED = 0;  // Default, invalid if used
    ANONYMOUS = 1;               // Unauthenticated
    BASIC = 2;                   // Basic authentication
    STRONG = 3;                  // Strong authentication
    VERY_STRONG = 4;             // Very strong authentication (e.g., MFA)
  }
}

// NEW: Usage limitations for approved data
message UsageLimitations {
  // Maximum time data can be retained
  uint64 max_retention_days = 1;
  
  // Whether data must be deleted after use
  bool must_delete_after_use = 2;
  
  // Whether the data can be processed offline
  bool allow_offline_processing = 3;
  
  // Optional: Geographic restrictions for data processing
  repeated string geographic_restrictions = 4;
  
  // Optional: Device or environment restrictions
  repeated string environment_restrictions = 5;
  
  // Optional: Specific processing limitations
  repeated ProcessingLimitation processing_limitations = 6;
  
  // Processing limitation details
  message ProcessingLimitation {
    // Type of limitation
    string limitation_type = 1;
    
    // Description of the limitation
    string description = 2;
    
    // Optional: Technical enforcement mechanism
    string enforcement_mechanism = 3;
  }
} 